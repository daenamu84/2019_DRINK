<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Proposal">
     
   
   
   
   <select id="getProPosalList" resultType="DataMap">
    	<![CDATA[
    		SELECT 
				A.PRPS_ID, 
				(SELECT TEAMNM FROM T_DEPT_M C WHERE C.DEPT_NO = B.DEPT_NO ) AS TEAMNM, 
				B.EMP_NM, 
				DATE_FORMAT(STR_TO_DATE(A.PRPS_STR_DT, '%Y%m%d'),'%Y.%m.%d ') AS PRPS_STR_DT,
				DATE_FORMAT(STR_TO_DATE(A.PRPS_END_DT, '%Y%m%d'),'%Y.%m.%d ') AS PRPS_END_DT,
				A.PRPS_NM,
				(SELECT D.OUTLET_NM FROM T_VENDOR_M D WHERE D.VENDOR_NO = A.OUTLET_NO) AS VD_NM,
				(SELECT E.CMM_CD_NM FROM T_CMM_CD_M E WHERE E.CMM_CD_GRP_ID='00021' AND E.CMM_CD = A.PRPS_PURPOSE_CD) AS PRPS_PURPOSE_CD_NM,
				(SELECT E.CMM_CD_NM FROM T_CMM_CD_M E WHERE E.CMM_CD_GRP_ID='00022' AND E.CMM_CD = A.ACT_PLAN_CD) AS ACT_PLAN_CD_NM,
				(SELECT E.CMM_CD_NM FROM T_CMM_CD_M E WHERE E.CMM_CD_GRP_ID='00020' AND E.CMM_CD = A.PRPS_STUS_CD) AS PRPS_STUS_CD_NM,
				A.WHOLESALE_VENDOR_NO, A.OUTLET_NO, A.MARKET_DIVS_CD, A.PRPS_PURPOSE_CD,
				A.ACT_PLAN_CD,A. BASE_PRPS_AMT, A.LAST_PRPS_AMT, A.BUDG_AMT, A.CASERATE_AMT, 
				A.PRPS_REG_DT, A.PRPS_STUS_CD,A. VENDOR_SGMT_DIVS_CD
			FROM T_PROPOSAL_M A , T_EMP_M B
			WHERE A.EMP_NO = B.EMP_NO
       	]]>
       	<if test="outlet_no != null and  outlet_no != ''">
			<![CDATA[
				AND A.OUTLET_NO = #{outlet_no}
			]]> 
		</if>
		<if test="deptno != null and deptno !='ALL' and emp_grd_cd != '0001' ">
			<![CDATA[
				AND B.DEPT_NO = #{deptno}
			]]> 
		</if>
		<if test="empno != null and empno != ''">
			<![CDATA[
				AND B.EMP_NO =  #{empno}
			]]> 
		</if>
		<if test="prps_purpose_cd != null and prps_purpose_cd !='ALL'">
			<![CDATA[
				AND A.PRPS_PURPOSE_CD = #{prps_purpose_cd}
			]]> 
		</if>
		<if test="act_plan_cd != null and act_plan_cd !='ALL'">
			<![CDATA[
				AND A.ACT_PLAN_CD = #{act_plan_cd}
			]]> 
		</if>
		<if test="prps_stus_cd != null and prps_stus_cd !='ALL'">
			<![CDATA[
				AND A.PRPS_STUS_CD = #{prps_stus_cd}
			]]> 
		</if>
		<if test="prps_str_dt !=null and prps_str_dt!='' and prps_end_dt !=null and prps_end_dt!=''">
			<![CDATA[
				AND #{prps_str_dt} BETWEEN A.PRPS_STR_DT AND A.PRPS_END_DT
				AND #{prps_end_dt} BETWEEN A.PRPS_STR_DT AND A.PRPS_END_DT
			]]> 
		</if>
		<if test="emp_grd_cd == '0004'">
			<![CDATA[
				AND A.EMP_NO =#{emp_no}
			]]> 
		</if>
		<if test="emp_grd_cd == '0003'">
			<![CDATA[
			    AND B.DEPT_NO=  #{deptno}
			]]> 
		</if>
		<if test="emp_grd_cd == '0002'">
			<![CDATA[
			    AND B.DEPT_NO IN (SELECT DEPT_NO  FROM T_DEPT_EMP_REL_D WHERE EMP_NO =#{emp_no} AND EMP_DEPT_REL_GBN_CD ='0002')
			]]> 			    
		</if>
		<![CDATA[
		ORDER BY A.DATA_REG_DTM DESC
		]]> 
    </select>
     
    <update id="masterInsert">
    	<![CDATA[
    	INSERT INTO T_PROPOSAL_M(
		  PRPS_STR_DT, PRPS_END_DT, DEPT_NO, EMP_NO, WHOLESALE_VENDOR_NO,
		  OUTLET_NO, MARKET_DIVS_CD, PRPS_NM, PRPS_PURPOSE_CD, ACT_PLAN_CD, 
		  BASE_PRPS_AMT, LAST_PRPS_AMT, BUDG_AMT, CASERATE_AMT, PRPS_CNTN, 
		  PRPS_REG_DT, PRPS_STUS_CD, VENDOR_SGMT_DIVS_CD, DATA_REG_DTM, DATA_REG_ID, 
		  DATA_UPD_DTM, DATA_UPD_ID
		)
		 VALUES (
			#{prps_str_dt}, #{prps_end_dt}, #{dept_no}, #{emp_no}, #{wholesale_vendor_no},
			#{outlet_no}, #{market_divs_cd}, #{prps_nm}, #{prps_purpose_cd}, #{act_plan_cd}, 
			#{base_prps_amt}, #{last_prps_amt},#{ budg_amt}, #{caserate_amt}, #{prps_cntn}, 
			DATE_FORMAT(now(), '%Y%m%d'), #{prps_stus_cd}, #{vendor_sgmt_divs_cd}, now(), #{login_id}, 
			now(), #{login_id}
		 )
    	]]>
    </update>
    
    <select id="getPRPS_ID" resultType="DataMap">
    	<![CDATA[
		  	SELECT PRPS_ID
			FROM T_PROPOSAL_M 
			WHERE OUTLET_NO =#{outlet_no}
			AND EMP_NO = #{emp_no}
			ORDER BY DATA_REG_DTM DESC LIMIT 1
			
       	]]>
    </select>

    <select id="getProPosal03List" resultType="DataMap">
    	<![CDATA[
		  	select 
				D.PRPSD_ID,
				M.PRPS_ID, 
				M.PRPS_STR_DT, M.PRPS_END_DT,
				D.PROD_SITEM_DIVS_CD, 
				D.PROD_NO_SITEM_NM, 
				D.DELIVERY_CNT,
				B.PLAN_DELIVERY_CNT,
				(SELECT B.BRAND_NM
								FROM T_PROD_M P, T_BRAND_M B, T_SUB_BRAND_M SB
								WHERE P.BRAND_ID = B.BRAND_ID
								AND P.SUB_BRAND_ID = SB.SUB_BRAND_ID
								AND B.BRAND_ID = SB.BRAND_ID
				        AND P.PROD_NO = D.PROD_NO_SITEM_NM
				        LIMIT 1
				        ) BRAND_NM,
				(SELECT SB.SUB_BRAND_NM
								FROM T_PROD_M P, T_BRAND_M B, T_SUB_BRAND_M SB
								WHERE P.BRAND_ID = B.BRAND_ID
								AND P.SUB_BRAND_ID = SB.SUB_BRAND_ID
								AND B.BRAND_ID = SB.BRAND_ID
				        AND P.PROD_NO = D.PROD_NO_SITEM_NM
				        LIMIT 1) SUB_BRAND_NM,
				 (SELECT (SELECT E.CMM_CD_NM FROM T_CMM_CD_M E WHERE E.CMM_CD_GRP_ID='00017' AND E.CMM_CD = P.PROD_ML_CD)
						FROM T_PROD_M P, T_BRAND_M B, T_SUB_BRAND_M SB
						WHERE P.BRAND_ID = B.BRAND_ID
						AND P.SUB_BRAND_ID = SB.SUB_BRAND_ID
						AND B.BRAND_ID = SB.BRAND_ID
		        AND P.PROD_NO = D.PROD_NO_SITEM_NM
		        LIMIT 1) PROD_ML_NM,    
				TIMESTAMPDIFF(month, DATE_FORMAT(M.PRPS_STR_DT, '%Y-%m-01') , DATE_FORMAT(M.PRPS_END_DT, '%Y-%m-01'))  AS monthCnt
			FROM T_PROPOSAL_M M, T_PROPOSAL_PROD_D D LEFT JOIN T_PROPOSAL_PROD_MON_D B
			ON D.PRPS_ID = B.PRPS_ID
			AND D.PROD_SITEM_DIVS_CD = B.PROD_SITEM_DIVS_CD
			AND D.PROD_NO_SITEM_NM = B.PROD_NO_SITEM_NM
			WHERE M.PRPS_ID = ${prps_id}
			AND M.PRPS_ID = D.PRPS_ID
       	]]>
    </select>
    
    
    
</mapper>