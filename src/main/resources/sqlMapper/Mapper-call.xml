<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Call">
    
     <select id="getCallCnt" resultType="DataMap">
    	<![CDATA[
    		 SELECT 
				COALESCE(count(SCALL_NO),0) CNT
			 FROM T_SALES_CALL_M
			 WHERE SCALL_NO = #{scall_no}   
       	]]>
    </select>
   
   
   <select id="getCallList" resultType="DataMap">
    	<![CDATA[
    		SELECT A.SCALL_NO, A.SCALL_DT, 
			 (SELECT E.CMM_CD_NM FROM T_CMM_CD_M E WHERE E.CMM_CD_GRP_ID='00012' AND E.CMM_CD = A.SCALL_GBN_NM) SCALL_GBN_NM_M
			 ,A.SCALL_GBN_NM
			 ,C.OUTLET_NM
			 ,(SELECT C.TEAMNM FROM T_DEPT_M C WHERE C.DEPT_NO = B.DEPT_NO) AS TEAMNM
			 , B.EMP_NM
			 ,(SELECT E.CMM_CD_NM FROM T_CMM_CD_M E WHERE E.CMM_CD_GRP_ID='00018' AND E.CMM_CD = A.SCALL_PURPOSE_CD) SCALL_PURPOSE_CD_NM
			 ,(SELECT E.CMM_CD_NM FROM T_CMM_CD_M E WHERE E.CMM_CD_GRP_ID='00013' AND E.CMM_CD = A.SCALL_PFR_NM) SCALL_PFR_NM
			FROM T_SALES_CALL_M A , T_EMP_M B , T_VENDOR_M  C ,  T_VENDOR_EMP_D D
			WHERE A.EMP_NO = B.EMP_NO
			AND A.VENDOR_NO = C.VENDOR_NO
			AND C.VENDOR_NO = D.VENDOR_NO
       	]]>
       	<if test="outlet_nm != null and  outlet_nm != ''">
			<![CDATA[
				AND C.OUTLET_NM like  CONCAT('%',#{outlet_nm},'%')
			]]> 
		</if>
		<if test="deptno != null and deptno !='ALL' ">
			<![CDATA[
				AND B.DEPT_NO = #{deptno}
			]]> 
		</if>
		<if test="empno != null and empno != ''">
			<![CDATA[
				AND B.EMP_NO =  #{"empno != null"}
			]]> 
		</if>
		<if test="scall_gbn_nm != null and scall_gbn_nm !='ALL'">
			<![CDATA[
				AND A.SCALL_GBN_NM = #{scall_gbn_nm}
			]]> 
		</if>
		<if test="scall_rslt_cd != null and scall_rslt_cd !='ALL'">
			<![CDATA[
				AND A.SCALL_RSLT_CD = #{scall_rslt_cd}
			]]> 
		</if>
		<if test="scallStaDt !=null and scallStaDt!='' and scallEndDt !=null and scallEndDt!=''">
			<![CDATA[
				AND A.SCALL_DT BETWEEN #{scallStaDt} AND #{scallEndDt}
			]]> 
		</if>
		<if test="emp_grd_cd == '0004'">
			<![CDATA[
				AND D.EMP_NO =#{emp_no}
			]]> 
		</if>
		<if test="emp_grd_cd == '0003'">
			<![CDATA[
			    AND B.DEPT_NO=  #{deptno}
			]]> 
		</if>
		<if test="emp_grd_cd == '0002'">
			<![CDATA[
			    AND B.DEPT_NO IN (SELECT DEPT_NO  FROM T_DEPT_EMP_REL_D WHERE EMP_NO =#{emp_no} AND EMP_DEPT_REL_GBN_CD ='0002')
			]]> 			    
		</if>
		<![CDATA[
		ORDER BY A.DATA_REG_DTM DESC
		]]> 
    </select>
   
   
    
   <update id="masterInsert">
    	<![CDATA[
    	INSERT INTO T_SALES_CALL_M
			(SCALL_DT, SCALL_GBN_NM, VENDOR_NO, EMP_NO, SCALL_PURPOSE_CD, SCALL_RSLT_CD, SCALL_PFR_NM, SCALL_SALE_CNTN, SCALL_CPRT_CNTN, DATA_REG_DTM, DATA_REG_ID, DATA_UPD_DTM, DATA_UPD_ID) 
			VALUES 
			( #{scall_dt}, #{scall_gbn_nm}, #{vendor_no}, #{emp_no}, #{scall_purpose_cd}, #{scall_rslt_cd}, #{scall_pfr_nm}, #{scall_sale_cntn}, #{scall_cprt_cntn}, now(), #{login_id}, now(), #{login_id})
    	]]>
    </update>
    
    <update id="masterUpdate">
    	<![CDATA[
    		UPDATE T_SALES_CALL_M
			SET  SCALL_PURPOSE_CD  = #{scall_purpose_cd}
			  ,SCALL_RSLT_CD  = #{scall_rslt_cd}
			  ,SCALL_PFR_NM  = #{scall_pfr_nm}
			  ,SCALL_SALE_CNTN  = #{scall_sale_cntn}
			  ,SCALL_CPRT_CNTN  = #{scall_cprt_cntn}
			  ,DATA_UPD_DTM = now()
			  ,DATA_UPD_ID = #{login_id}
    	    WHERE SCALL_NO = #{scall_no}
    	]]>
    </update>
    			
    <update id="callDelete">
    	<![CDATA[
    		DELETE FROM T_SALES_CALL_M WHERE SCALL_NO = #{scall_no}
    	]]>
    </update>
    
    <select id="callView" resultType="DataMap">
    	<![CDATA[
    		SELECT A.SCALL_NO, A.SCALL_DT
				,(SELECT E.CMM_CD_NM FROM T_CMM_CD_M E WHERE E.CMM_CD_GRP_ID='00012' AND E.CMM_CD = A.SCALL_GBN_NM) SCALL_GBN_NM_M
				, A.SCALL_GBN_NM , C.OUTLET_NM
				, (SELECT C.TEAMNM FROM   T_DEPT_M C WHERE  C.DEPT_NO = B.DEPT_NO) AS TEAMNM 
				, B.EMP_NM, A.SCALL_PURPOSE_CD , A.SCALL_PFR_NM, A.SCALL_SALE_CNTN, A.SCALL_CPRT_CNTN
				, A.SCALL_RSLT_CD
			FROM T_SALES_CALL_M A , T_EMP_M B , T_VENDOR_M  C ,  T_VENDOR_EMP_D D
			WHERE A.SCALL_NO =  #{scall_no}
			AND A.EMP_NO = B.EMP_NO
			AND A.VENDOR_NO = C.VENDOR_NO
			AND C.VENDOR_NO = D.VENDOR_NO
       	]]>
       	
		<if test="deptno != null and deptno !='ALL' ">
			<![CDATA[
				AND B.DEPT_NO = #{deptno}
			]]> 
		</if>
		<if test="empno != null and empno != ''">
			<![CDATA[
				AND B.EMP_NO =  #{"empno != null"}
			]]> 
		</if>
		
		<if test="emp_grd_cd == '0004'">
			<![CDATA[
				AND D.EMP_NO =#{emp_no}
			]]> 
		</if>
		<if test="emp_grd_cd == '0003'">
			<![CDATA[
			    AND B.DEPT_NO=  #{deptno}
			]]> 
		</if>
		<if test="emp_grd_cd == '0002'">
			<![CDATA[
			    AND B.DEPT_NO IN (SELECT DEPT_NO  FROM T_DEPT_EMP_REL_D WHERE EMP_NO =#{emp_no} AND EMP_DEPT_REL_GBN_CD ='0002')
			]]> 			    
		</if>
		
     
    </select>
    
</mapper>